# ====================================================
# ğŸ Base Image
# ====================================================
FROM python:3.10-slim

# ----------------------------------------------------
# Set working directory
# ----------------------------------------------------
WORKDIR /app

# ----------------------------------------------------
# ğŸ§© Install system dependencies
# ----------------------------------------------------
RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    curl \
    netcat-openbsd \
    tzdata && \
    ln -fs /usr/share/zoneinfo/Asia/Manila /etc/localtime && \
    dpkg-reconfigure -f noninteractive tzdata && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ----------------------------------------------------
# ğŸ• Timezone
# ----------------------------------------------------
ENV TZ=Asia/Manila

# ----------------------------------------------------
# âš™ï¸ Python dependencies
# ----------------------------------------------------
COPY requirements.txt .

# âœ… Upgrade pip safely and with retries/timeouts
RUN pip install --default-timeout=120 --retries=10 --no-cache-dir --upgrade pip==24.2 setuptools wheel && \
    PIP_DEFAULT_TIMEOUT=120 \
    pip install --no-cache-dir -r requirements.txt --timeout 120 --retries 10 --index-url https://pypi.org/simple --progress-bar off

# ----------------------------------------------------
# ğŸ“¦ Copy app source
# ----------------------------------------------------
COPY . .

# ----------------------------------------------------
# ğŸ§° Entrypoint
# ----------------------------------------------------
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# ----------------------------------------------------
# ğŸŒ Expose backend port
# ----------------------------------------------------
EXPOSE 8000

# ----------------------------------------------------
# ğŸš€ Default entrypoint
# ----------------------------------------------------
ENTRYPOINT ["/entrypoint.sh"]
