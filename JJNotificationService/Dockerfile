# ====================================================
# üêç Base Image
# ====================================================
FROM python:3.10-slim

# ----------------------------------------------------
# Set working directory
# ----------------------------------------------------
WORKDIR /app

# ----------------------------------------------------
# üß© Install system dependencies
# ----------------------------------------------------
RUN apt-get update && apt-get install -y \
    build-essential \
    libpq-dev \
    curl \
    netcat-openbsd \
    tzdata && \
    ln -fs /usr/share/zoneinfo/Asia/Manila /etc/localtime && \
    dpkg-reconfigure -f noninteractive tzdata && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ----------------------------------------------------
# üïê Timezone
# ----------------------------------------------------
ENV TZ=Asia/Manila

# ----------------------------------------------------
# ‚öôÔ∏è Python dependencies
# ----------------------------------------------------
COPY requirements.txt .

# ‚úÖ Upgrade pip safely and with retries/timeouts
RUN pip install --default-timeout=120 --retries=10 --no-cache-dir --upgrade pip==24.2 setuptools wheel && \
    PIP_DEFAULT_TIMEOUT=120 \
    pip install --no-cache-dir -r requirements.txt --timeout 120 --retries 10 --index-url https://pypi.org/simple --progress-bar off

# ----------------------------------------------------
# üì¶ Copy app source
# ----------------------------------------------------
COPY . .

# ----------------------------------------------------
# üß∞ Entrypoint
# ----------------------------------------------------
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# ----------------------------------------------------
# üåê Expose backend port
# ----------------------------------------------------
EXPOSE 8000

# ----------------------------------------------------
# üöÄ Environment Configs for Dev Autoreload
# ----------------------------------------------------
# Exclude .venv and migrations folders from uvicorn autoreload scan
ENV UVICORN_RELOAD_EXCLUDES=".venv,migrations,__pycache__"

# ----------------------------------------------------
# üöÄ Default entrypoint
# ----------------------------------------------------
ENTRYPOINT ["/entrypoint.sh"]
